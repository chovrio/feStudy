---
title: ä»é›¶å¼€å‘ä¸€æ¬¾è‡ªå·±çš„è„šæ‰‹æ¶
description: è¿™æ˜¯æˆ‘å…³äºè„šæ‰‹æ¶å¼€å‘çš„ç¬¬ä¸€ç¯‡åšæ–‡ã€‚
slug: cli
authors:
  - name: chovrio
    title: æ— 
    url: https://github.com/chovrio
    image_url: https://github.com/chovrio.png
tags: [cli]
image: https://i.imgur.com/mErPwqL.png
hide_table_of_contents: false
---

## å‰è¨€

ä¸€ä¸ªæ™®æ™®é€šé€šçš„è„šæ‰‹æ¶ï¼ŒåŒ…å«éƒ¨åˆ†å¯¹å·¥ç¨‹åŒ–ï¼Œrollup çš„è¿ç”¨ï¼Œä»¥åŠä¸€ä¸¤ä¸ªä¸ªäººè§‰å¾—æŒºå¥½ç”¨çš„å°åŠŸèƒ½

## æºç 

[chovrio-cli](https://github.com/chovrio/chovrio-cli)

[demo-cli](https://github.com/chovrio/demo-cli)

## é¡¹ç›®å¼€å‘ç¯å¢ƒæ­å»º

**å¿«é€Ÿå¼€å‘å¯ä»¥è€ƒè™‘è¯•ä¸€è¯• modernjs ä¸ç”¨è‡ªå·±æ­å»ºç¯å¢ƒ**

### é¦–å…ˆåˆ›å»ºæ–‡ä»¶å¤¹å¹¶ç”¨`vscode`æ‰“å¼€

```shell
mkdir cli-demo # åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹
cd cli-demo # è¿›å…¥é¡¹ç›®æ–‡ä»¶å¤¹
code . # ä½¿ç”¨vscodeæ‰“å¼€(å¦‚æœå®‰è£…vscodeçš„æ—¶å€™æ²¡é…ç½®ç¯å¢ƒå˜é‡å¯èƒ½ä¼šæŠ¥é”™ï¼Œæ‰‹åŠ¨æ‰“å¼€ä¹Ÿå¯)
pnpm init # ç”Ÿæˆpackage.jsonæ–‡ä»¶
mkdir packages # åˆ›å»ºåŒ…æ–‡ä»¶å¤¹(è¦é‡‡ç”¨monorepoçš„æ–¹å¼è¿›è¡Œç®¡ç†)
cd packages
mkdir chovrio # åˆ›å»ºè„šæ‰‹æ¶æ–‡ä»¶å¤¹
mkdir plugins # åˆ›å»ºæ’ä»¶æ–‡ä»¶å¤¹
cd chovrio
pnpm init
cd ..
cd plugins
pnpm init
```

å¼€å§‹æ­å»ºå¼€å‘ç¯å¢ƒï¼Œé¦–å…ˆæˆ‘ä»¬è¦ä»ä¸€å¼€å§‹å°±æ˜ç¡®æŠ€æœ¯æ ˆï¼Œæˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯ rollup + typescript å¹¶ä¸”ä»¥ monorepo çš„æ–¹å¼è¿›è¡Œç®¡ç†(è™½ç„¶æš‚æ—¶æ²¡æƒ³è¦å†™ pluginï¼Œå…·ä½“åŸå› æ–‡ä¸­åº”è¯¥ä¼šè¯´åˆ°)ã€‚

### å·¥ç¨‹åŒ–

#### eslint

```shell
pnpm add typescript @types/node -D
pnpm add eslint -D
npx eslint --init
```

ä¸‹é¢æ˜¯æˆ‘çš„ä¸€äº›é…ç½®

![image-20230312193314090](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230312193314090.png)

#### prettier

å®‰è£…

```shell
pnpm add prettier eslint-config-prettier eslint-plugin-prettier -D
```

åˆ›å»º`.prettierrc`æ–‡ä»¶

```.prettierrc
// ä¸€äº›é…ç½®,å¯è‡ªå®šä¹‰
{
  "semi": false,
  "tabWidth": 2,
  "trailingComma": "none",
  "singleQuote": true,
  "arrowParens": "avoid"
}
```

é…ç½®å‚è€ƒ [prettier å®˜ç½‘](https://prettier.io/docs/en/configuration.html) [æ˜é‡‘æ–‡ç« ](https://juejin.cn/post/6938687606687432740)

#### git æäº¤è§„èŒƒ

```shell
pnpm add lint-staged husky -D
pnpm pkg set scripts.prepare="husky install"
```

åˆ›å»º`.gitignore`æ–‡ä»¶

```.gitignode
node_modules
```

```shell
git init
pnpm prepare # åˆå§‹åŒ–husky
npx husky add .husky/pre-commit "npx lint-staged"
```

**pre-commit** æ—¶æ‰§è¡Œ **npx lint-staged** æŒ‡ä»¤

æ ¹ç›®å½•åˆ›å»º **.lintstagedrc.json** æ–‡ä»¶æ§åˆ¶æ£€æŸ¥å’Œæ“ä½œæ–¹å¼

```lintstagedrc.json
{
    "*.{js,jsx,ts,tsx}": ["prettier --write .", "eslint  --fix"],
    "*.md": ["prettier --write"]
}
```

#### git æäº¤è§„èŒƒ:commitlint

è§„èŒƒä¾èµ–

```shell
pnpm add commitlint @commitlint/config-conventional -D
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'
```

é»˜è®¤æ˜¯ angular çš„æäº¤è§„èŒƒï¼Œä¸€èˆ¬é»˜è®¤å°±å¤Ÿç”¨äº†ï¼Œå¯ä»¥è‡ªå®šä¹‰

è¾…åŠ©æäº¤ä¾èµ–

```shell
pnpm add commitizen cz-conventional-changelog -D
pnpm pkg set scripts.commit="git add . && git-cz" # package.json ä¸­æ·»åŠ  commit æŒ‡ä»¤, æ‰§è¡Œ `git-cz` æŒ‡ä»¤
```

åˆ›å»ºæ–‡ä»¶`commitlint.config.ts` è¿™é‡Œé‡‡ç”¨é»˜è®¤è§„èŒƒ

```ts
module.exports = {
  extends: ["@commitlint/config-conventional"],
};
```

æˆ‘ä»¬åœ¨`packages/chovrio`ä¸‹æ–°å»º`index.ts`

```ts
console.log("hello world");
```

æ­¤æ—¶æˆ‘ä»¬è¿è¡Œå‘½ä»¤`pnpm commit`

![image-20230313144433340](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313144433340.png)

æ›´å¤šè¯¦ç»†é…ç½®çš„è¯å¯ä»¥å»çœ‹çœ‹`lint-staged`ã€`commitlint`ã€`commitizen`çš„æ–‡æ¡£

### monorepo å’Œ ts

#### monorepo(è™½ç„¶å› ä¸ºä¸œè¥¿ä¸å¤šï¼Œmonorepo æ²¡æ€ä¹ˆç”¨ä¸Šï¼Œä½†è¿˜æ˜¯å…ˆå¼„ä¸Š)

åœ¨æ ¹ç›®å½•æ–°å»ºæ–‡ä»¶`pnpm-workspace.yaml`

```yaml
packages:
  - "packages/*"
```

ä¿®æ”¹`chovrio`å’Œ`plugins`ä¸‹çš„`package.json`çš„`name`åˆ†åˆ«ä¸º`chovrio`å’Œ`@chovrio/plugins`

åœ¨`chovrio`å’Œ`plugins`æ–‡ä»¶å¤¹ä¸‹éƒ½è¿è¡Œ`npx tsc --init`ç”Ÿæˆ`tsconfig.json`æ–‡ä»¶

### Rollup é›†æˆ

æˆ‘ä»¬å°±ä¸€æ­¥ä¸€æ­¥æ­å»ºå§

#### rollup é…ç½®æ–‡ä»¶

`-w`è¡¨ç¤ºå®‰è£…åˆ°`workspace(æ ¹å·¥ä½œç©ºé—´)`ç„¶åé¡¹ç›®çš„å­åŒ…éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªä¾èµ–(ä¸çŸ¥é“è¿™æ ·ç†è§£æœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜),åœ¨å“ªä¸ªåŒ…é‡Œé¢å®‰è£…éƒ½ä¼šå®‰è£…åˆ°æ ¹åŒ…

```shell
pnpm add rollup -wD
pnpm pkg set scripts.build="rollup --config rollup.config.ts --configPlugin typescript" # é…ç½®æ’ä»¶ typescript
cd .\packages\chovrio\
mkdir src
cd src
mkdir core
mkdir utils
mkdir types
mkdir command
```

å°†ä¹‹å‰æµ‹è¯• git æµç¨‹æ—¶åœ¨ chovrio ç›®å½•ä¸‹çš„åˆ›å»ºçš„ index.ts æ–‡ä»¶ç§»åŠ¨åˆ° core ç›®å½•é‡Œé¢ã€‚

åœ¨`chovrio`ç›®å½•ä¸‹é¢åˆ›å»º`rollup.config.ts`

```ts
import path from "path";
import { defineConfig } from "rollup";

const cliConfig = defineConfig({
  // å…¥å£æ–‡ä»¶
  input: "./src/core/index.ts",
  // è¾“å‡ºç›®å½•
  output: {
    file: path.resolve(__dirname, "./dist/cli.js"),
  },
  // ç”¨åˆ°çš„æ’ä»¶
  plugins: [],
});
export default defineConfig([cliConfig]);
```

æ­¤æ—¶æˆ‘ä»¬è¿è¡Œ`pnpm build`ä¼šå‘ç°ä¸èƒ½è¯†åˆ«`rollup.config.ts`

![image-20230313151813786](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313151813786.png)

æˆ‘ä»¬ä¿®æ”¹`tsconfig.json`

```ts
{
  "extends": "./tsconfig.base.json",
  // è¿™é‡Œå‘Šè¯‰typescriptè¦ç¼–è¯‘rollupçš„é…ç½®æ–‡ä»¶
  "include": ["./rollup.config.ts"],
  "compilerOptions": {
    "esModuleInterop": true,
    "declaration": false,
    "resolveJsonModule": true
  }
}
```

æ–°å»ºæ–‡ä»¶`tsconfig.base.json`

```ts
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "node",
    "strict": true,
    "declaration": true,
    "noImplicitOverride": true,
    "noUnusedLocals": true,
    "esModuleInterop": true,
    "useUnknownInCatchVariables": false
  }
}
```

è¿™é‡Œé€‰æ‹©åœ¨ tsconfig.ts ä¸­é›†æˆ tsconfig.base.json æ˜¯ä¸ºäº†å‡å°‘ä»£ç é‡

è¿è¡Œ`pnpm build`ä¼šå‘ç°æŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬æ‰“åŒ…çš„æ˜¯ ts æ–‡ä»¶ï¼Œrollup é»˜è®¤åªèƒ½æ‰“åŒ… js æ–‡ä»¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€äº›æ’ä»¶æ¥æ‰©å±• rollup çš„åŠŸèƒ½

![image-20230313152646512](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313152646512.png)

#### æ‰“åŒ… ts æ–‡ä»¶

```shell
pnpm add @rollup/plugin-typescript -wD
```

å®‰è£…åä¿®æ”¹`rollup.config.ts`æ–‡ä»¶å¦‚ä¸‹

```ts
import path from "path";
import ts from "@rollup/plugin-typescript";
import { defineConfig } from "rollup";

const cliConfig = defineConfig({
  // å…¥å£æ–‡ä»¶
  input: "./src/core/index.ts",
  // è¾“å‡ºç›®å½•
  output: {
    file: path.resolve(__dirname, "./dist/cli.js"),
  },
  // ç”¨åˆ°çš„æ’ä»¶
  plugins: [ts({ tsconfig: path.resolve(__dirname, "./tsconfig.json") })],
});
export default defineConfig([cliConfig]);
```

å†æ¬¡è¿è¡Œ`pnpm build`ï¼Œä¼šå‘ç°åˆæŠ¥é”™äº†

![image-20230313153729486](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313153729486.png)

å› ä¸º`__dirname`æ˜¯`commonjs`è§„èŒƒé‡Œé¢çš„ï¼Œåœ¨`esmodule`ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨åˆ«çš„æ–¹å¼ä½¿ç”¨`__dirname`ï¼Œä¸€è¡Œå°±è§£å†³äº†

```ts
const __dirname = fileURLToPath(new URL(".", import.meta.url));
```

æˆ‘æƒ³è¿‡ç›´æ¥ç”¨`process.cwd()`æ¥ä»£æ›¿`__dirname`ï¼Œä½†æ˜¯æˆ‘å‘ç°ç”¨`fileURLToPath`å’Œ`URL`çš„æ¯”è¾ƒå¤šï¼Œäºæ˜¯æˆ‘å»é—®äº†é—® bingğŸ™ƒ

![image-20230313155711738](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313155711738.png)

å†æ¬¡æ‰“åŒ…å°±èƒ½é€šè¿‡äº†

![image-20230313155801693](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313155801693.png)

#### å‹ç¼©ä»£ç å’Œè¯»å– json æ–‡ä»¶

æˆ‘ä»¬å†ä½¿ç”¨ä¸€ä¸ªæ’ä»¶ç”¨æ¥å‹ç¼©æ‰“åŒ…åçš„ä»£ç 

```shell
pnpm add @rollup/plugin-terser @rollup/plugin-json -wD
```

```ts
import path from "path";
import { defineConfig } from "rollup";
import ts from "@rollup/plugin-typescript";
import terser from "@rollup/plugin-terser";
import json from "@rollup/plugin-json";
import { fileURLToPath } from "url";
const __dirname = fileURLToPath(new URL(".", import.meta.url));
const cliConfig = defineConfig({
  // å…¥å£æ–‡ä»¶
  input: "./src/core/index.ts",
  // è¾“å‡ºç›®å½•
  output: {
    file: path.resolve(__dirname, "./dist/cli.js"),
  },
  // ç”¨åˆ°çš„æ’ä»¶
  plugins: [
    ts({ tsconfig: path.resolve(__dirname, "./tsconfig.json") }),
    terser({
      toplevel: true,
    }),
    json(),
  ],
});
export default defineConfig([cliConfig]);
```

```shell
pnpm pkg set scripts.build:dev="rollup --config rollup.config.ts --configPlugin typescript --watch" # å¼€å‘é˜¶æ®µçš„æ‰“åŒ…å‘½ä»¤
```

rollup çš„é…ç½®æš‚æ—¶å°±åˆ°è¿™å„¿äº†

### è„šæ‰‹æ¶å¼€å‘

è„šæ‰‹æ¶å¼€å‘çš„åŸºç¡€åŒ…æŒºå¤šçš„ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ commanderï¼Œæ¯”è¾ƒå¤§ä¼—

æ³¨æ„è¿™ä¸ªå‘½ä»¤æ˜¯åœ¨ chovrio ç›®å½•ä¸‹æ‰§è¡Œçš„æ²¡æœ‰åŠ `-w`è¿™ä¸ªä¾èµ–æ˜¯åªæœ‰ chovrio è¿™ä¸ªé¡¹ç›®ä½¿ç”¨çš„ï¼Œä¸ç”¨æ”¾åœ¨å·¥ä½œç©ºé—´ã€‚

rollup çš„æ’ä»¶å•¥çš„æ”¾åœ¨å·¥ä½œç©ºé—´æ˜¯å› ä¸ºå¦‚æœè¦å¼€å‘å…¶å®ƒåŒ…å°±å¯ä»¥ç›´æ¥åœ¨å­åŒ…ä¸­ä½¿ç”¨ï¼Œä¸ç”¨å†æ¬¡å®‰è£…ä¾èµ–

```shell
pnpm add commander -D
pnpm build:dev
```

æˆ‘ä»¬å…ˆä¸ä½¿ç”¨ commanderï¼Œæˆ‘ä»¬å…ˆè®©æˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œèµ·æ¥

æ–°å¢`chovrio/bin/demo.js`å¦‚ä¸‹

```ts
#!/usr/bin/env node
function start() {
  return import("../dist/cli.js");
}
start();
```

åœ¨`package.json`ä¸­å¢åŠ æ¡†é€‰ä»£ç 

![image-20230313162456162](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313162456162.png)

æ‰§è¡Œ`npm link`è¿™æ ·å¯ä»¥æŠŠ`bin`ä¸­çš„å‘½ä»¤é…ç½®åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œæƒ³å½“äºæ¯æ¬¡æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥`demo`ï¼Œéƒ½ä¼šé“¾æ¥åˆ°`demo.js`è¿™ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å»æ‰§è¡Œå®ƒï¼Œä½†æ˜¯ js æ–‡ä»¶åœ¨å‘½ä»¤è¡Œä¸­å¹¶ä¸èƒ½ç›´æ¥æ‰§è¡Œï¼Œéœ€è¦ node ç¯å¢ƒ`#!/usr/bin/env node`ï¼Œ

![image-20230313161925403](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313161925403.png)

å®é™…ä¸Šæˆ‘ä»¬æ¯æ¬¡è¿ç”¨åŒ…ç®¡ç†å·¥å…·çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨å»æ£€æµ‹`package.json`ä¸­æ˜¯å¦æœ‰`bin`è¿™ä¸ªé…ç½®ï¼Œå¦‚æœæœ‰ä¼šè‡ªåŠ¨æ‰§è¡Œç±»ä¼¼`npm link`çš„å‘½ä»¤å°†å‘½ä»¤å†™å…¥ç¯å¢ƒå˜é‡ã€‚

æˆ‘ä»¬å…ˆ`npm link`å†æ‰§è¡Œ`demo` **æ³¨æ„ï¼Œå¾—åœ¨è„šæ‰‹æ¶æ–‡ä»¶å¤¹ä¸‹é¢æ‰§è¡Œ**

![image-20230313162537117](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313162537117.png)

è„šæ‰‹æ¶åŠŸèƒ½çš„æ·»åŠ å°±å¾ˆåƒå¥‡ç™¾æ€ªäº†ï¼Œæˆ‘è¿™é‡Œå°±å†™ä¸¤ä¸ªä¸ªäººè§‰å¾—ç¨å¾®æœ‰ä¸€ç‚¹æ„æ€çš„åŠŸèƒ½å§ã€‚

- è„šæ‰‹æ¶é…ç½®æ–‡ä»¶çš„ä¸€ç§å®ç°æ€è·¯
- éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨

#### ä¸»æ–‡ä»¶

è¿™é‡Œå°±ç›´æ¥ cv äº†ï¼Œå¾ˆç®€å•ï¼Œå› ä¸ºæƒ³è¦é›†æˆæ’ä»¶(è™½ç„¶è¿˜æ²¡å†™)ï¼Œæ‰€ä»¥æˆ‘å†™æˆçš„ä¸€ä¸ªç±»ï¼Œæ›´åŠ ç›´è§‚

```ts
// chovrio/core/index.ts
import { Command, program } from "commander";
import { version } from "../../package.json";
class Chovrio {
  program: Command;
  commands: Array<(program: Command) => void>;
  constructor() {
    this.program = program;
    this.commands = [];
    this.init();
    this.program.option("-v, --version").action(() => {
      console.log(version);
    });
    this.program.parse();
  }
  init() {
    this.commands.forEach((command) => {
      command(program);
    });
  }
}
const cli = new Chovrio();
cli.program.version(version);
```

#### è„šæ‰‹æ¶é…ç½®æ–‡ä»¶

ç›®å‰å°±åªèƒ½æ˜¯`demo.config.js`æ–‡ä»¶ï¼Œåç»­å¯èƒ½ä¼šæ”¯æŒ ts æ–‡ä»¶ï¼Œæ³¨æ„æ–‡ä»¶ä½ç½®å¾—æ˜¯å‘½ä»¤æ‰§è¡Œçš„è·¯å¾„

æ–°å»º`utils/parse.ts`

```ts
import fs from "fs";
import type { Config } from "../types";
// è·å¾—æ¨¡æ¿æ–‡ä»¶å¹¶è§£ææˆå¯¹è±¡
export default function parse() {
  const config = fs
    .readFileSync(`${process.cwd()}/demo.config.js`, "utf-8")
    .replace(/[\s|\n]/g, "");
  const reg = /\{(.*)\}/;
  if (reg.test(config)) {
    const arr = reg.exec(config);
    if (arr !== null) {
      const config: Config = new Function("return " + arr[0])();
      return config;
    }
  }
}
```

æ–°å»º`utils/__dirname`

```ts
import { fileURLToPath } from "url";
export const __dirname = fileURLToPath(new URL(".", import.meta.url));
```

æ–°å»º`types/config.ts`

```ts
import type { RollupOptions } from "rollup";
export interface Config {
  rollupOptions?: RollupOptions;
  deploy?: {
    position: string;
  };
}
```

æ–°å»º`types/index.ts`

```ts
export * from "./config";
```

è¿™é‡Œç±»å‹éƒ½åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å¯¼å‡ºæ˜¯ä¸ºäº†åé¢æ–¹ä¾¿æ‰“åŒ…æˆç±»å‹å£°æ˜æ–‡ä»¶

æ–°å»º`command/deploy.ts`

```ts
import parse from "../utils/parse";
import type { Command } from "commander";
export default function deploy(program: Command) {
  program
    .command("deploy")
    .description("deploy a project to server")
    .action(async () => {
      const config = parse();
      console.log(config);
    });
}
```

ä¿®æ”¹`core/index.ts`

```ts
import { Command, program } from "commander";
import { version } from "../../package.json";
import deploy from "../command/deploy";
class Chovrio {
  program: Command;
  commands: Array<(program: Command) => void>;
  constructor() {
    this.program = program;
    this.commands = [deploy];
    this.init();
    this.program.option("-v, --version").action(() => {
      console.log(version);
    });
    this.program.parse();
  }
  init() {
    this.commands.forEach((command) => {
      command(program);
    });
  }
}
const cli = new Chovrio();
cli.program.version(version);
```

åˆ›å»ºé…ç½®æ–‡ä»¶`demo.config.js`

```js
export default {
  name: "chovrio",
  age: 19,
};
```

æ‰§è¡Œå‘½ä»¤`demo deploy`å¯ä»¥çœ‹åˆ°

![image-20230313185051977](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313185051977.png)

ç›®å‰è¿™ç§å­—ç¬¦ä¸²è½¬å¯¹è±¡çš„æ–¹å¼åªèƒ½è§£æ js æ–‡ä»¶ï¼Œåç»­åº”è¯¥ä¼šæ”¹æˆåˆ«çš„æ–¹æ³•ç”¨æ¥æ”¯æŒ ts æ–‡ä»¶ï¼Œä¸è¿‡ç›®å‰çš„æ•ˆæœ esmodule å’Œ commonjs è§„èŒƒçš„å¯¼å‡ºéƒ½å¯ä»¥è§£æ

#### éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨

åœ¨ä¸Šä¸€æ­¥æˆ‘ä»¬å·²ç»åˆ›å»ºå¥½äº†`deploy`å‘½ä»¤

å…ˆè¯´è¯´ä¸ºä»€ä¹ˆè¦å†™è¿™ä¸ªéƒ¨ç½²æ–‡ä»¶çš„å‘½ä»¤å§ï¼Œå› ä¸ºæˆ‘çš„æœåŠ¡å™¨è·‘`ci/co`æœ‰ç‚¹....ï¼Œå—¯ï¼Œåˆä¸æƒ³æ¯æ¬¡éƒ½æ‰‹åŠ¨ä¸Šä¼ ã€‚

æˆ‘ä»¬é€šè¿‡`node-ssh`è¿æ¥è¿œç¨‹æœåŠ¡å™¨

```shell
pnpm add node-ssh
```

åˆå› ä¸ºè¿æ¥è¿œç¨‹æœåŠ¡å™¨è‚¯å®šè¦ç”¨åˆ°ç«¯å£å·ç”¨æˆ·åå’Œå¯†ç ï¼Œä½ ä¹Ÿä¸æƒ³è‡ªå·±çš„ä¿¡æ¯è¢«æš´éœ²å§ ğŸ˜ˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨åˆ°`dotenv`

```shell
pnpm add dotenv
```

åœ¨ä½ å‡†å¤‡æ‰§è¡Œè„šæ‰‹æ¶å‘½ä»¤çš„åŒçº§ç›®å½•ä¸‹åˆ›å»º`.env`æ–‡ä»¶

```properties
host=xxxxx # ç«¯å£å·
user=xxxxx # ç”¨æˆ·å è¿™é‡Œæ²¡ç”¨ usernameçš„åŸå› æ˜¯æˆ‘æœ¬åœ°é»˜è®¤ç”¨æˆ·åä¼šæ˜¯ chovrio
password=xxxxx # å¯†ç 
```

æ–°å»º`utils/env.ts`

```ts
import * as dotenv from "dotenv";
dotenv.config();
export default process.env;
```

å®‰è£…ä¸¤ä¸ªç¾åŒ–å‘½ä»¤è¡Œçš„å·¥å…·

```shell
pnpm add ora picocolors
```

ora å¯ä»¥è®©æˆ‘ä»¬ loading çš„æ—¶å€™å¥½çœ‹ä¸€äº›ï¼Œpicocolors å¯ä»¥æ”¹å˜è¾“å‡ºçš„æ–‡å­—é¢œè‰²

ä¿®æ”¹`commander/deploy`

```ts
import parse from "../utils/parse";
import type { Command } from "commander";
import ora from "ora";
import pc from "picocolors";
import { NodeSSH } from "node-ssh";
import env from "../utils/env";
export default function deploy(program: Command) {
  program
    // å‘½ä»¤
    .command("deploy")
    // å‘½ä»¤æè¿°
    .description("deploy a project to server")
    // è§£æåˆ°è¿™ä¸ªå‘½ä»¤å è¦æ‰§è¡Œçš„æ“ä½œ
    .action(async () => {
      const config = parse();
      const ssh = new NodeSSH();
      console.log(config);
      // 1.è¿æ¥æœåŠ¡å™¨
      // 1.1 å­˜åœ¨.envæ–‡ä»¶ä¸”å…·æœ‰æ•°æ®å°±è¯»å–æ–‡ä»¶è¿æ¥
      if (env.user && env.password && env.host) {
        const connectSpinner = ora(pc.blue(`connect server...`)).start();
        await ssh.connect({
          host: env.host,
          username: env.user,
          password: env.password,
        });
        connectSpinner.stop();
        console.log("æœåŠ¡å™¨è¿æ¥æˆåŠŸ");
        // é€€å‡ºç»ˆç«¯
        process.exit(0);
      }
    });
}
```

ç°åœ¨æˆ‘ä»¬æ‰§è¡Œ`demo deploy`å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ•ˆæœ(è¿™é‡Œæ²¡é“¾æ¥ä¸Šæ—¶æ˜¯æœ‰åŠ¨ç”»)

![image-20230313191104485](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313191104485.png)

æˆ‘ä»¬ç°åœ¨å†å†™å¦ä¸€ç§é€»è¾‘ï¼Œå°±æ˜¯ç”¨æˆ·è§‰å¾—.env æ–‡ä»¶ä¹Ÿä¸å®‰å…¨ï¼Œä¸‡ä¸€ä¸å°å¿ƒå¿˜è®°å¿½ç•¥äº†ä¸Šä¼ åˆ° github åå°±å°´å°¬äº†ï¼Œäºæ˜¯æ–°å¢ä¸€ä¸ªæœªæ£€æµ‹åˆ° env æ–‡ä»¶æ‰‹åŠ¨è¾“å…¥çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬è¦å€ŸåŠ©ä¸€ä¸ªåŒ…`readline-sync`,node åŸç”Ÿçš„`readline`å¥½åƒé»˜è®¤æ˜¯å¼‚æ­¥ä¼šï¼Œå’Œ`ora`æ­é…åœ¨ä¸€èµ·ä½¿ç”¨æŒºå°¬çš„ã€‚

```shell
pnpm add readline-sync
```

```ts
// deploy.ts
import parse from "../utils/parse";
import type { Command } from "commander";
import ora from "ora";
import pc from "picocolors";
import { NodeSSH } from "node-ssh";
import readline from "readline-sync";
import env from "../utils/env";
export default function deploy(program: Command) {
  program
    // å‘½ä»¤
    .command("deploy")
    // å‘½ä»¤æè¿°
    .description("deploy a project to server")
    // è§£æåˆ°è¿™ä¸ªå‘½ä»¤å è¦æ‰§è¡Œçš„æ“ä½œ
    .action(async () => {
      const config = parse();
      const ssh = new NodeSSH();
      let host, username, password;
      console.log(config);
      // 1.è¿æ¥æœåŠ¡å™¨
      // 1.1 å­˜åœ¨.envæ–‡ä»¶ä¸”å…·æœ‰æ•°æ®å°±è¯»å–æ–‡ä»¶è¿æ¥
      if (env.user && env.password && env.host) {
        host = env.host;
        username = env.user;
        password = env.password;
      } else {
        // 1.2 ä¸å­˜åœ¨å°±é‡‡å–è¾“å…¥æ–¹å¼è¿æ¥
        host = readline.question(`Your server ip address${pc.blue("(host)")}:`);
        username = readline.question(
          `The user name you want to log in to${pc.blue("(username)")}:`
        );
        password = readline.question(`Your password${pc.blue("(password)")}:`);
      }
      const connectSpinner = ora(pc.blue(`connect server...`)).start();
      try {
        await ssh.connect({
          host,
          username,
          password,
        });
        console.log("æ•°æ®åº“è¿æ¥æˆåŠŸ");
      } catch (err) {
        console.log("æ•°æ®é”™è¯¯ï¼Œè¿æ¥å¤±è´¥", err.message);
      }
      connectSpinner.stop();
      process.exit(0);
    });
}
```

![image-20230313191743218](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313191743218.png)

è¿™é‡Œåé¢è‚¯å®šä¼šæŠ¥é”™çš„ï¼Œè¿æ¥ä¸ä¸Šã€‚

è¿™é‡Œè¿æ¥æ•°æ®åº“æˆ‘ä»¬å·²ç»åšå¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨äº†ï¼Œ

æˆ‘ä»¬å…ˆåˆ é™¤åŸæœ¬æ–‡ä»¶å¤¹(å°±ä¸å…¨æ–‡ä»¶å¤åˆ¶äº†ï¼Œä¸ç„¶å¤ªé•¿äº†)

è¿™é‡Œçš„ config å°±æ˜¯æˆ‘ä»¬ä¹‹å‰å†™çš„é…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶é‡Œé¢çš„ deploy.position å°±æ˜¯æˆ‘ä»¬è¦ä¸Šä¼ çš„ä½ç½®

```ts
const deleteSpinner = ora(pc.blue(`delete folder...`)).start();
const remotePath = config?.deploy?.position || "";
await ssh.execCommand(`rm -rf ${remotePath}`);
deleteSpinner.stop();
console.log(pc.green("åˆ é™¤æ–‡ä»¶æˆåŠŸ~"));
```

ç°åœ¨åœ¨æˆ‘çš„æœåŠ¡å™¨çš„`/home/test/hahaha`ç›®å½•ä¸‹æœ‰ä¸€ä¸ª cli æ–‡ä»¶å¤¹ã€‚æˆ‘ä»¬è¦ä¸Šä¼ æ–°æ–‡ä»¶åˆ°`hahaha`è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œé¢![image-20230313192923456](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313192923456.png)

è¿™æ˜¯æˆ‘çš„é…ç½®æ–‡ä»¶

```js
// demo.config.js
export default {
  deploy: {
    position: "/home/test/hahaha",
  },
};
```

æ­¤æ—¶æ‰§è¡Œ` demo deploy`

![image-20230313193535742](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313193535742.png)

æœ€ä¸Šé¢çš„å¯¹è±¡æ˜¯æˆ‘ä»¬æ‰“å°çš„ configï¼ŒæœåŠ¡å™¨ä¸Šçš„ hahaha æ–‡ä»¶å¤¹å·²ç»æ²¡äº†

![image-20230313193611741](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313193611741.png)

æˆ‘ä»¬æœ€åå†ä¸Šä¼ ç¨‹åºæ‰§è¡Œä½ç½®ä¸‹çš„ dist æ–‡ä»¶å¤¹ä¸Šå»

```ts
// 3.ä¸Šä¼ æ–‡ä»¶
const uploadSpinner = ora(pc.blue(`upload folder...`)).start();
const status = await ssh.putDirectory(process.cwd() + "/dist", remotePath, {
  recursive: true,
  concurrency: 10,
});
uploadSpinner.stop();
if (status) {
  console.log(pc.green("æ–‡ä»¶ä¸Šä¼ æœåŠ¡å™¨æˆåŠŸ~"));
} else {
  console.log(pc.red("æ–‡ä»¶ä¸Šä¼ æœåŠ¡å™¨å¤±è´¥"));
}
process.exit(0);
```

æ•´ä¸ªæ–‡ä»¶ deploy æ–‡ä»¶

```ts
// deploy.ts
import parse from "../utils/parse";
import type { Command } from "commander";
import ora from "ora";
import pc from "picocolors";
import { NodeSSH } from "node-ssh";
import readline from "readline-sync";
import env from "../utils/env";
export default function deploy(program: Command) {
  program
    // å‘½ä»¤
    .command("deploy")
    // å‘½ä»¤æè¿°
    .description("deploy a project to server")
    // è§£æåˆ°è¿™ä¸ªå‘½ä»¤å è¦æ‰§è¡Œçš„æ“ä½œ
    .action(async () => {
      const config = parse();
      const ssh = new NodeSSH();
      let host, username, password;
      // 1.è¿æ¥æœåŠ¡å™¨
      // 1.1 å­˜åœ¨.envæ–‡ä»¶ä¸”å…·æœ‰æ•°æ®å°±è¯»å–æ–‡ä»¶è¿æ¥
      if (env.user && env.password && env.host) {
        host = env.host;
        username = env.user;
        password = env.password;
      } else {
        // 1.2 ä¸å­˜åœ¨å°±é‡‡å–è¾“å…¥æ–¹å¼è¿æ¥
        host = readline.question(`Your server ip address${pc.blue("(host)")}:`);
        username = readline.question(
          `The user name you want to log in to${pc.blue("(username)")}:`
        );
        password = readline.question(`Your password${pc.blue("(password)")}:`);
      }
      const connectSpinner = ora(pc.blue(`connect server...`)).start();
      try {
        await ssh.connect({
          host,
          username,
          password,
        });
        connectSpinner.stop();
        console.log(pc.green("æœåŠ¡å™¨è¿æ¥æˆåŠŸ~"));
      } catch (err) {
        connectSpinner.stop();
        console.log(pc.red("æ•°æ®é”™è¯¯ï¼Œè¿æ¥å¤±è´¥" + err.message));
      }
      // 2.åˆ é™¤åŸæœ‰æ–‡ä»¶å¤¹å†…å®¹
      const deleteSpinner = ora(pc.blue(`delete folder...`)).start();
      const remotePath = config?.deploy?.position || "";
      await ssh.execCommand(`rm -rf ${remotePath}`);
      deleteSpinner.stop();
      console.log(pc.green("åˆ é™¤æ–‡ä»¶æˆåŠŸ~"));
      // 3.ä¸Šä¼ æ–‡ä»¶
      const uploadSpinner = ora(pc.blue(`upload folder...`)).start();
      const status = await ssh.putDirectory(
        process.cwd() + "/dist",
        remotePath,
        {
          recursive: true,
          concurrency: 10,
        }
      );
      uploadSpinner.stop();
      if (status) {
        console.log(pc.green("æ–‡ä»¶ä¸Šä¼ æœåŠ¡å™¨æˆåŠŸ~"));
      } else {
        console.log(pc.red("æ–‡ä»¶ä¸Šä¼ æœåŠ¡å™¨å¤±è´¥"));
      }
      process.exit(0);
    });
}
```

å†æ¬¡æ‰§è¡Œ`demo deploy`

![image-20230313193945895](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313193945895.png)

![image-20230313194028137](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313194028137.png)

æ­¤æ—¶ä¸Šä¼ æ–‡ä»¶çš„é€»è¾‘å°±å·²ç»å®Œå…¨å®ç°äº†ã€‚

æ­¤æ—¶æˆ‘ä»¬æ‰§è¡Œ`pnpm build`ä¼šæŠ¥é”™

![image-20230313194848537](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313194848537.png)

ä¸èƒ½è¯†åˆ«åˆ° ts æ–‡ä»¶ï¼Œæˆ‘ä»¬çš„ plugin ä¸­è¯»å–çš„æ˜¯`chovrio/tsconfig.js`

æˆ‘ä»¬ä¿®æ”¹å®ƒå¦‚ä¸‹ï¼Œå°±åŠ å…¥äº†ä¸»æ–‡ä»¶åˆ° include é‡Œé¢

```json
{
  "extends": "./tsconfig.base.json",
  "include": ["./rollup.config.ts", "./src/core/index.ts"],
  "compilerOptions": {
    "esModuleInterop": true,
    "declaration": false,
    "resolveJsonModule": true
  }
}
```

æˆ‘ä»¬å†æ¬¡æ‰§è¡Œæ‰“åŒ…ä¼šå‘ç°å­˜åœ¨ä¾èµ–å…³ç³»çš„é—®é¢˜

![image-20230313195301266](https://chart-r0m2qgkmn-astrues.vercel.app/cli/image-20230313195301266.png)

æš‚æ—¶æ²¡æƒ³åˆ°è¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£å†³ï¼Œè·Ÿç€æ–‡æ¡£èµ°ä¹Ÿæ²¡è§£å†³ï¼Œä¸è¿‡å¼€å‘åæ˜¯æ²¡é—®é¢˜çš„ç›´æ¥ä¸Šä¼  bin å’Œ dist ç›®å½•å‘åŒ…æ˜¯èƒ½ç”¨çš„
